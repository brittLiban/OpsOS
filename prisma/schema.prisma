generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum MembershipRole {
  OWNER
  MEMBER
}

enum LeadLifecycleStatus {
  OPEN
  WON
  LOST
  CONVERTED
  MERGED
  ARCHIVED
}

enum StageType {
  OPEN
  WON
  LOST
}

enum StageColor {
  SLATE
  BLUE
  TEAL
  GREEN
  AMBER
  ORANGE
  RED
  PINK
  INDIGO
  CYAN
}

enum TouchpointType {
  CALL
  EMAIL
  SMS
  MEETING
  NOTE
  OTHER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ClientStatus {
  ACTIVE
  ONBOARDING
  PAUSED
  CHURNED
}

enum OnboardingStatus {
  TODO
  DONE
  SKIPPED
}

enum BillingStatus {
  DUE
  PAID
  OVERDUE
  VOID
}

enum CustomFieldEntityType {
  LEAD
  CLIENT
  TASK
}

enum CustomFieldType {
  TEXT
  TEXTAREA
  NUMBER
  SELECT
  MULTI_SELECT
  DATE
  BOOLEAN
}

enum ImportRunStatus {
  DRAFT
  MAPPING
  PREVIEW_READY
  RUNNING
  COMPLETED
  FAILED
  CANCELED
}

enum ImportRowStatus {
  PENDING
  CREATED
  HARD_DUPLICATE
  SOFT_DUPLICATE
  ERROR
  SKIPPED
  MERGED
}

enum ImportRowAction {
  CREATE
  SKIP
  LINK_EXISTING
  MERGE
}

model Workspace {
  id                String             @id @default(uuid()) @db.Uuid
  name              String
  timezone          String             @default("America/New_York")
  stripeSecretKeyEncrypted String?
  stripeWebhookSecretEncrypted String?
  stripeKeyHint     String?
  stripeWebhookHint String?
  stripeConfiguredAt DateTime?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  memberships       Membership[]
  pipelines         Pipeline[]
  stages            Stage[]
  leads             Lead[]
  touchpoints       Touchpoint[]
  taskTypes         TaskType[]
  tasks             Task[]
  clients           Client[]
  onboardingItems   OnboardingItem[]
  clientNotes       ClientNote[]
  billingTypes      BillingType[]
  billingRecords    BillingRecord[]
  scriptCategories  ScriptCategory[]
  scriptTemplates   ScriptTemplate[]
  customFields      CustomField[]
  entityFieldValues EntityFieldValue[]
  importRuns        ImportRun[]
  importRows        ImportRow[]
  mergeLogs         MergeLog[]
}

model User {
  id              String           @id @default(uuid()) @db.Uuid
  email           String           @unique
  displayName     String
  passwordHash    String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  memberships     Membership[]
  ownedLeads      Lead[]           @relation("LeadOwner")
  leadTouchpoints Touchpoint[]     @relation("TouchpointAuthor")
  assignedTasks   Task[]           @relation("TaskAssignee")
  createdTasks    Task[]           @relation("TaskCreator")
  clientNotes     ClientNote[]     @relation("ClientNoteAuthor")
  createdScripts  ScriptTemplate[] @relation("ScriptCreatedBy")
  updatedScripts  ScriptTemplate[] @relation("ScriptUpdatedBy")
  importRuns      ImportRun[]      @relation("ImportUploadedBy")
  mergeLogs       MergeLog[]       @relation("MergePerformedBy")
}

model Membership {
  id          String         @id @default(uuid()) @db.Uuid
  workspaceId String         @db.Uuid
  userId      String         @db.Uuid
  role        MembershipRole @default(MEMBER)
  createdAt   DateTime       @default(now())
  workspace   Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Pipeline {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  name        String
  isActive    Boolean   @default(true)
  isDefault   Boolean   @default(false)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  stages      Stage[]
  leads       Lead[]

  @@unique([workspaceId, name])
  @@index([workspaceId, isActive])
  @@index([workspaceId, sortOrder])
}

model Stage {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  pipelineId  String    @db.Uuid
  name        String
  sortOrder   Int
  color       StageColor
  stageType   StageType @default(OPEN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  pipeline    Pipeline  @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  leads       Lead[]

  @@unique([pipelineId, sortOrder])
  @@unique([pipelineId, name])
  @@index([pipelineId, sortOrder])
}

model TaskType {
  id          String     @id @default(uuid()) @db.Uuid
  workspaceId String     @db.Uuid
  name        String
  color       StageColor @default(BLUE)
  sortOrder   Int        @default(0)
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  workspace   Workspace  @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@unique([workspaceId, name])
  @@index([workspaceId, sortOrder])
}

model Lead {
  id                  String              @id @default(uuid()) @db.Uuid
  workspaceId         String              @db.Uuid
  pipelineId          String              @db.Uuid
  stageId             String              @db.Uuid
  ownerId             String?             @db.Uuid
  businessName        String
  contactName         String?
  email               String?
  phone               String?
  website             String?
  city                String?
  source              String?
  niche               String?
  status              LeadLifecycleStatus @default(OPEN)
  leadValue           Decimal?            @db.Decimal(12, 2)
  nextFollowUpAt      DateTime?
  lastContactedAt     DateTime?
  emailNorm           String?
  phoneNorm           String?
  domainNorm          String?
  nameNorm            String?
  cityNorm            String?
  customData          Json                @default("{}")
  mergedIntoLeadId    String?             @db.Uuid
  archivedAt          DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  workspace           Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  pipeline            Pipeline            @relation(fields: [pipelineId], references: [id], onDelete: Restrict)
  stage               Stage               @relation(fields: [stageId], references: [id], onDelete: Restrict)
  owner               User?               @relation("LeadOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  touchpoints         Touchpoint[]
  tasks               Task[]
  sourceClient        Client?             @relation("ClientSourceLead")
  matchedImportRows   ImportRow[]         @relation("ImportMatchedLead")
  createdImportRows   ImportRow[]         @relation("ImportCreatedLead")
  primaryMergeLogs    MergeLog[]          @relation("MergePrimaryLead")
  mergedMergeLogs     MergeLog[]          @relation("MergeMergedLead")
  mergedIntoLead      Lead?               @relation("LeadMergeTarget", fields: [mergedIntoLeadId], references: [id], onDelete: SetNull)
  mergedLeads         Lead[]              @relation("LeadMergeTarget")

  @@index([pipelineId, stageId])
  @@index([nextFollowUpAt])
  @@index([createdAt])
  @@index([workspaceId, pipelineId, stageId, createdAt])
  @@index([workspaceId, emailNorm])
  @@index([workspaceId, phoneNorm])
  @@index([workspaceId, domainNorm])
  @@index([workspaceId, nameNorm, cityNorm])
}

model Touchpoint {
  id             String         @id @default(uuid()) @db.Uuid
  workspaceId    String         @db.Uuid
  leadId         String         @db.Uuid
  type           TouchpointType
  outcome        String?
  summary        String?
  notes          String?
  happenedAt     DateTime       @default(now())
  nextFollowUpAt DateTime?
  createdById    String?        @db.Uuid
  createdAt      DateTime       @default(now())
  workspace      Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead           Lead           @relation(fields: [leadId], references: [id], onDelete: Cascade)
  createdBy      User?          @relation("TouchpointAuthor", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([leadId, createdAt])
  @@index([workspaceId, createdAt])
}

model Client {
  id                 String       @id @default(uuid()) @db.Uuid
  workspaceId        String       @db.Uuid
  sourceLeadId       String?      @unique @db.Uuid
  ownerId            String?      @db.Uuid
  name               String
  primaryContactName String?
  email              String?
  phone              String?
  stripeCustomerId   String?      @unique
  status             ClientStatus @default(ACTIVE)
  customData         Json         @default("{}")
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  workspace          Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  sourceLead         Lead?        @relation("ClientSourceLead", fields: [sourceLeadId], references: [id], onDelete: SetNull)
  tasks              Task[]
  onboardingItems    OnboardingItem[]
  notes              ClientNote[]
  billingRecords     BillingRecord[]

  @@index([workspaceId, status])
  @@index([workspaceId, createdAt])
}

model Task {
  id          String       @id @default(uuid()) @db.Uuid
  workspaceId String       @db.Uuid
  leadId      String?      @db.Uuid
  clientId    String?      @db.Uuid
  taskTypeId  String?      @db.Uuid
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueAt       DateTime?
  completedAt DateTime?
  customData  Json         @default("{}")
  assigneeId  String?      @db.Uuid
  createdById String?      @db.Uuid
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  lead        Lead?        @relation(fields: [leadId], references: [id], onDelete: Cascade)
  client      Client?      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  taskType    TaskType?    @relation(fields: [taskTypeId], references: [id], onDelete: SetNull)
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdBy   User?        @relation("TaskCreator", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([dueAt, status])
  @@index([workspaceId, status, dueAt])
  @@index([leadId, status])
  @@index([clientId, status])
}

model OnboardingItem {
  id          String           @id @default(uuid()) @db.Uuid
  workspaceId String           @db.Uuid
  clientId    String           @db.Uuid
  title       String
  description String?
  sortOrder   Int
  status      OnboardingStatus @default(TODO)
  dueAt       DateTime?
  completedAt DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  workspace   Workspace        @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client      Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, sortOrder])
  @@index([clientId, status])
}

model ClientNote {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  clientId    String    @db.Uuid
  authorId    String?   @db.Uuid
  body        String
  createdAt   DateTime  @default(now())
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  author      User?     @relation("ClientNoteAuthor", fields: [authorId], references: [id], onDelete: SetNull)

  @@index([clientId, createdAt])
}

model BillingType {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  key         String?
  name        String
  sortOrder   Int       @default(0)
  isSystem    Boolean   @default(false)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  records     BillingRecord[]

  @@unique([workspaceId, name])
  @@unique([workspaceId, key])
  @@index([workspaceId, sortOrder])
}

model BillingRecord {
  id            String        @id @default(uuid()) @db.Uuid
  workspaceId   String        @db.Uuid
  clientId      String        @db.Uuid
  billingTypeId String        @db.Uuid
  amount        Decimal       @db.Decimal(12, 2)
  currency      String        @default("usd")
  dueDate       DateTime      @db.Date
  status        BillingStatus @default(DUE)
  paidAt        DateTime?
  stripeCheckoutSessionId String? @unique
  stripePaymentIntentId   String? @unique
  stripePaymentStatus     String?
  stripeLastEventAt       DateTime?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  workspace     Workspace     @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  billingType   BillingType   @relation(fields: [billingTypeId], references: [id], onDelete: Restrict)

  @@index([workspaceId, status, dueDate])
  @@index([clientId, dueDate])
}

model ScriptCategory {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  name        String
  sortOrder   Int       @default(0)
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  scripts     ScriptTemplate[]

  @@unique([workspaceId, name])
  @@index([workspaceId, sortOrder])
}

model ScriptTemplate {
  id          String          @id @default(uuid()) @db.Uuid
  workspaceId String          @db.Uuid
  categoryId  String?         @db.Uuid
  title       String
  content     String
  tags        String[]        @default([])
  isActive    Boolean         @default(true)
  createdById String?         @db.Uuid
  updatedById String?         @db.Uuid
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  workspace   Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  category    ScriptCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  createdBy   User?           @relation("ScriptCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy   User?           @relation("ScriptUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  @@index([workspaceId, categoryId])
  @@index([workspaceId, title])
}

model CustomField {
  id          String                @id @default(uuid()) @db.Uuid
  workspaceId String                @db.Uuid
  entityType  CustomFieldEntityType
  key         String
  label       String
  fieldType   CustomFieldType
  isRequired  Boolean               @default(false)
  showInTable Boolean               @default(false)
  isActive    Boolean               @default(true)
  sortOrder   Int                   @default(0)
  placeholder String?
  helperText  String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  workspace   Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  options     CustomFieldOption[]
  values      EntityFieldValue[]

  @@unique([workspaceId, entityType, key])
  @@index([workspaceId, entityType, isActive])
  @@index([workspaceId, entityType, showInTable])
}

model CustomFieldOption {
  id            String      @id @default(uuid()) @db.Uuid
  customFieldId String      @db.Uuid
  label         String
  value         String
  sortOrder     Int         @default(0)
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([customFieldId, value])
  @@index([customFieldId, sortOrder])
}

model EntityFieldValue {
  id            String                @id @default(uuid()) @db.Uuid
  workspaceId   String                @db.Uuid
  entityType    CustomFieldEntityType
  entityId      String                @db.Uuid
  customFieldId String                @db.Uuid
  valueText     String?
  valueNumber   Decimal?              @db.Decimal(14, 4)
  valueDate     DateTime?             @db.Date
  valueBoolean  Boolean?
  valueJson     Json?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  workspace     Workspace             @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  customField   CustomField           @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, entityType, entityId, customFieldId])
  @@index([workspaceId, entityType, entityId])
  @@index([workspaceId, customFieldId, valueText])
  @@index([workspaceId, customFieldId, valueNumber])
  @@index([workspaceId, customFieldId, valueDate])
  @@index([workspaceId, customFieldId, valueBoolean])
}

model ImportRun {
  id                 String          @id @default(uuid()) @db.Uuid
  workspaceId        String          @db.Uuid
  uploadedById       String?         @db.Uuid
  filename           String
  fileChecksum       String?
  idempotencyKey     String?
  status             ImportRunStatus @default(DRAFT)
  columnMappingJson  Json?
  totalRows          Int             @default(0)
  processedRows      Int             @default(0)
  createdCount       Int             @default(0)
  hardDuplicateCount Int             @default(0)
  softDuplicateCount Int             @default(0)
  errorCount         Int             @default(0)
  startedAt          DateTime?
  finishedAt         DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  workspace          Workspace       @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  uploadedBy         User?           @relation("ImportUploadedBy", fields: [uploadedById], references: [id], onDelete: SetNull)
  rows               ImportRow[]
  mergeLogs          MergeLog[]

  @@index([workspaceId, createdAt])
  @@index([workspaceId, status])
  @@unique([workspaceId, idempotencyKey])
}

model ImportRow {
  id               String         @id @default(uuid()) @db.Uuid
  workspaceId      String         @db.Uuid
  importRunId      String         @db.Uuid
  rowNumber        Int
  rowHash          String?
  rawJson          Json
  normalizedJson   Json
  status           ImportRowStatus @default(PENDING)
  reason           String?
  matchedLeadId    String?        @db.Uuid
  softScore        Float?
  chosenAction     ImportRowAction?
  createdLeadId    String?        @db.Uuid
  mergedIntoLeadId String?        @db.Uuid
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  workspace        Workspace      @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  importRun        ImportRun      @relation(fields: [importRunId], references: [id], onDelete: Cascade)
  matchedLead      Lead?          @relation("ImportMatchedLead", fields: [matchedLeadId], references: [id], onDelete: SetNull)
  createdLead      Lead?          @relation("ImportCreatedLead", fields: [createdLeadId], references: [id], onDelete: SetNull)

  @@unique([importRunId, rowNumber])
  @@index([importRunId, status])
  @@index([workspaceId, status])
}

model MergeLog {
  id              String    @id @default(uuid()) @db.Uuid
  workspaceId     String    @db.Uuid
  importRunId     String?   @db.Uuid
  primaryLeadId   String    @db.Uuid
  mergedLeadId    String    @db.Uuid
  chosenFields    Json
  beforeAfterJson Json
  reason          String?
  mergedById      String?   @db.Uuid
  mergedAt        DateTime  @default(now())
  createdAt       DateTime  @default(now())
  workspace       Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  importRun       ImportRun? @relation(fields: [importRunId], references: [id], onDelete: SetNull)
  primaryLead     Lead      @relation("MergePrimaryLead", fields: [primaryLeadId], references: [id], onDelete: Restrict)
  mergedLead      Lead      @relation("MergeMergedLead", fields: [mergedLeadId], references: [id], onDelete: Restrict)
  mergedBy        User?     @relation("MergePerformedBy", fields: [mergedById], references: [id], onDelete: SetNull)

  @@index([workspaceId, createdAt])
  @@index([primaryLeadId, createdAt])
}
